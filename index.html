<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Crypto Wealth Tracker</title>
  <head>
  <link rel="stylesheet" href="style.css">
    
    <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Wealth Scanner</title>
  <meta name="description" content="Scan & track your onchain wealth in one click" />

  <!-- Farcaster Mini App Meta (WAJIB) -->
  <meta name="fc:miniapp" content='{"version":"1","name":"Crypto Wealth Scanner","iconUrl":"https://wealthscan.vercel.app/icon.png","homeUrl":"https://wealthscan.vercel.app/"}' />

  <!-- OpenGraph Tags (biar preview & cast jadi cantik) -->
  <meta property="og:title" content="Crypto Wealth Scanner" />
  <meta property="og:description" content="Enter wallet address → instantly see portfolio & net worth" />
  <meta property="og:image" content="https://wealthscan.vercel.app/og-image.png" />
  <meta property="og:url" content="https://wealthscan.vercel.app/" />
  <meta property="og:type" content="website" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Crypto Wealth Scanner" />
  <meta name="twitter:description" content="Simple onchain portfolio tracker" />
  <meta name="twitter:image" content="https://wealthscan.vercel.app/og-image.png" />

  <!-- Farcaster Mini App SDK (wajib) -->
  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk@latest";

    window.addEventListener("load", async () => {
      try {
        // Bilang ke Farcaster bahwa app sudah siap → splash screen otomatis ilang
        await sdk.actions.ready();
        console.log("Mini App ready!");

        // Optional: tombol Add manual (muncul di preview & browser)
        const btn = document.createElement("button");
        btn.textContent = "Add to Farcaster Apps";
        btn.style.cssText = `
          position:fixed; bottom:20px; right:20px; z-index:99999;
          padding:12px 24px; background:#a855f7; color:white;
          border:none; border-radius:50px; font-weight:bold;
          box-shadow:0 4px 20px rgba(168,85,247,0.4);
        `;
        btn.onclick = () => sdk.actions.addMiniApp();
        document.body.appendChild(btn);

      } catch (e) {
        console.log("Bukan di dalam Farcaster / belum Mini App context");
      }
    });
  </script>

</head>
<body>

<h2>Crypto Wealth Scanner </h2>

<input id="wallet" placeholder="Enter Your Wallet (0x...)" />

<button onclick="cekWallet()">Start Scanning</button>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top:8px;color:#0aff9d;">Loading data...</div>
</div>

<div id="result"></div>

<script>
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjA2OTE5MmFmLTAxNzctNDBkYi04NjQwLTYzN2I0ZjJmNmNlMSIsIm9yZ0lkIjoiNDgzNjY0IiwidXNlcklkIjoiNDk3NjAzIiwidHlwZUlkIjoiYzU3ZjA0YTktNDM4Ni00MDQ5LWFhMGUtOWVmNTBmMmJlNWExIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjQzNzAyMzMsImV4cCI6NDkyMDEzMDIzM30.0kda5g8LQ3pI9SHBOaRK8dWkJSsELOWwQlojPEJDP_o"; // pakai key kamu tadi

const CHAINS = {
  "eth": "Ethereum",
  "bsc": "BNB Chain",
  "polygon": "Polygon",
  "arbitrum": "Arbitrum",
  "avalanche": "Avalanche",
  "optimism": "Optimism"
};

// LP & Staking hanya tersedia di chain berikut:
const DEFI_CHAINS = ["eth", "polygon", "bsc", "arbitrum"];

function shortAddr(addr) {
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}

async function safeFetch(url) {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);

    let res = await fetch(url, {
      headers: { "X-API-Key": API_KEY },
      signal: controller.signal
    });

    clearTimeout(timeout);
    return await res.json();
  } catch (e) {
    console.log("Fetch error:", e);
    return null;
  }
}

async function cekWallet() {
  const wallet = document.getElementById("wallet").value.trim();
  const loader = document.getElementById("loader");
  const result = document.getElementById("result");

  result.innerHTML = "";
  if (!wallet) return result.innerHTML = "Enter your wallet address!";

  loader.style.display = "block";

  let totalUSD = 0;
  let perChain = {};
  let lpPositions = [];
  let stakingPositions = [];

  /* ======================================================
        1. TOKEN MULTICHAIN (ini jalan di semua chain)
  ========================================================= */
  for (const chain in CHAINS) {
    const data = await safeFetch(
      `https://deep-index.moralis.io/api/v2.2/wallets/${wallet}/tokens?chain=${chain}`
    );

    if (!data?.result) continue;

    let tokens = [];
    data.result.forEach(t => {
      if (!t.usd_price || t.possible_spam) return;
      const amount = t.balance / (10 ** t.decimals);
      const usd = amount * t.usd_price;
      if (usd < 0.1) return;

      tokens.push({
        symbol: t.symbol,
        amount,
        usd,
        logo: t.logo || t.thumbnail || "https://via.placeholder.com/32",
        contract: t.token_address
      });
      totalUSD += usd;
    });

    tokens.sort((a, b) => b.usd - a.usd);
    perChain[chain] = tokens;
  }

  /* ======================================================
        2. LP & STAKING (hanya chain tertentu)
  ========================================================= */
  for (const chain of DEFI_CHAINS) {

    // LP
    const lp = await safeFetch(
      `https://deep-index.moralis.io/api/v2.2/wallets/${wallet}/defi/lp?chain=${chain}`
    );

    if (lp?.result?.length > 0) {
      lp.result.forEach(x => {
        if (x.usd_value > 0.1) {
          lpPositions.push(x);
          totalUSD += x.usd_value;
        }
      });
    }

    // Staking
    const st = await safeFetch(
      `https://deep-index.moralis.io/api/v2.2/wallets/${wallet}/defi/staking?chain=${chain}`
    );

    if (st?.result?.length > 0) {
      st.result.forEach(x => {
        if (x.usd_value > 0.1) {
          stakingPositions.push(x);
          totalUSD += x.usd_value;
        }
      });
    }
  }

  loader.style.display = "none";

  /* ======================================================
        3. TAMPILKAN SEMUA
  ========================================================= */
  result.innerHTML = `<h2>Value: $${totalUSD.toFixed(2)}</h2>`;

  // TOKEN berdasarkan chain
  for (const chain in perChain) {
    const tokens = perChain[chain];
    if (!tokens || tokens.length === 0) continue;

    result.innerHTML += `<h3>${CHAINS[chain]}</h3>`;

    tokens.forEach(t => {
      result.innerHTML += `
        <div class="token-box">
          <img src="${t.logo}">
          <div style="flex:1;">
            <div class="token-name" style="font-size:18px;font-weight:bold;">${t.symbol}</div>
            <div style="font-size:14px;color:#ccc;">
              ${t.amount.toFixed(4)} — $${t.usd.toFixed(2)}
            </div>
            <a href="https://etherscan.io/token/${t.contract}" 
               target="_blank"
               style="color:#0aff9d;font-size:12px;">
              ${shortAddr(t.contract)}
            </a>
          </div>
        </div>
      `;
    });
  }

  // LP Positions
  if (lpPositions.length > 0) {
    result.innerHTML += `<h3>Liquidity (LP)</h3>`;
    lpPositions.forEach(lp => {
      result.innerHTML += `
        <div class="token-box">
          <div style="flex:1;">
            <div class="token-name" style="font-size:18px;font-weight:bold;">
              ${lp.pair}
            </div>
            <div style="font-size:14px;color:#ccc;">
              $${lp.usd_value.toFixed(2)}
            </div>
          </div>
        </div>
      `;
    });
  }

  // Staking Positions
  if (stakingPositions.length > 0) {
    result.innerHTML += `<h3>Staking</h3>`;
    stakingPositions.forEach(st => {
      result.innerHTML += `
        <div class="token-box">
          <div style="flex:1;">
            <div class="token-name" style="font-size:18px;font-weight:bold;">
              ${st.protocol_name || "Protocol"}
            </div>
            <div style="font-size:14px;color:#ccc;">
              $${st.usd_value.toFixed(2)}
            </div>
          </div>
        </div>
      `;
    });
  }
}
</script>

</body>
</html>
